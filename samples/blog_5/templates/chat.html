{% extends "base.html" %}

{% block title %}Chat - ChatBot{% endblock %}

{% block head %}
<style>
    #chat-container {
        height: calc(100vh - 200px);
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
    }
    
    .message {
        padding: 12px 16px;
        margin: 8px 0;
        border-radius: 12px;
        max-width: 80%;
        word-wrap: break-word;
    }
    
    .message.user {
        background-color: #007bff;
        color: white;
        margin-left: auto;
        margin-right: 0;
    }
    
    .message.assistant {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        margin-right: auto;
        margin-left: 0;
    }
    
    .message-header {
        font-size: 0.875rem;
        opacity: 0.8;
        margin-bottom: 4px;
    }
    
    .message-content {
        white-space: pre-wrap;
    }
    
    .typing-indicator {
        display: none;
        padding: 12px 16px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 12px;
        margin: 8px 0;
        max-width: 80%;
    }
    
    .typing-dots {
        display: flex;
        align-items: center;
    }
    
    .typing-dots span {
        height: 8px;
        width: 8px;
        background-color: #6c757d;
        border-radius: 50%;
        display: inline-block;
        margin: 0 1px;
        animation: typing 1.4s infinite ease-in-out;
    }
    
    .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
    .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
    
    @keyframes typing {
        0%, 80%, 100% {
            transform: scale(0.8);
            opacity: 0.5;
        }
        40% {
            transform: scale(1);
            opacity: 1;
        }
    }
    
    #message-input {
        border-radius: 20px;
        padding-left: 20px;
        padding-right: 60px;
    }
    
    #send-button {
        border-radius: 20px;
        position: absolute;
        right: 8px;
        top: 8px;
        bottom: 8px;
        width: 40px;
    }
    
    .personality-selector {
        transition: all 0.2s ease;
    }
    
    .personality-selector:focus {
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        border-color: #28a745;
    }
    
    #apply-personality-chat-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }
    
    .quick-switch-hint {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Chat Area -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex align-items-center justify-content-between">
                        <h5 class="mb-0">
                            <i class="fas fa-comments me-2"></i>
                            Chat with {{ assistant_name }}
                        </h5>
                        <div class="badge bg-light text-primary">{{ current_role }}</div>
                    </div>
                </div>
                
                <div class="card-body p-0">
                    <div id="chat-container" class="p-3">
                        <!-- Messages will be dynamically added here -->
                        <div class="text-center text-muted py-5">
                            <i class="fas fa-robot fa-3x mb-3"></i>
                            <p>Start a conversation with {{ assistant_name }}!</p>
                            <p class="small">Current role: {{ current_role }}</p>
                        </div>
                    </div>
                    
                    <!-- Typing indicator -->
                    <div id="typing-indicator" class="typing-indicator mx-3">
                        <div class="message-header">
                            <i class="fas fa-robot me-1"></i>
                            {{ assistant_name }} is typing...
                        </div>
                        <div class="typing-dots">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    </div>
                </div>
                
                <div class="card-footer">
                    <form id="chat-form" class="position-relative">
                        <textarea 
                            id="message-input" 
                            class="form-control" 
                            placeholder="Type your message here... (Press Ctrl+Enter to send)"
                            rows="2"
                            maxlength="2000"
                        ></textarea>
                        <button type="submit" id="send-button" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </form>
                    <div class="d-flex justify-content-between align-items-center mt-2">
                        <small class="text-muted">
                            <span id="char-count">0</span>/2000 characters
                        </small>
                        <div>
                            <button type="button" id="clear-chat" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-trash me-1"></i>
                                Clear Chat
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="card shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Chat Information
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <strong>Current Role:</strong>
                        <div class="badge bg-primary ms-2">{{ current_role }}</div>
                    </div>
                    <div class="mb-3">
                        <strong>Assistant:</strong> {{ assistant_name }}
                    </div>
                    <div class="mb-3">
                        <strong>Quick Personality Switch:</strong>
                        <div class="input-group input-group-sm mt-2">
                            <select class="form-select personality-selector" id="chat-personality-selector">
                                <option value="">Select personality...</option>
                            </select>
                            <button class="btn btn-outline-success" type="button" id="apply-personality-chat-btn" onclick="quickApplyPersonality()" disabled title="Apply selected personality">
                                <i class="fas fa-check"></i>
                            </button>
                        </div>
                        <div class="quick-switch-hint">
                            <i class="fas fa-info-circle me-1"></i>
                            Switch personality without changing roles
                        </div>
                    </div>
                    <div class="mb-3">
                        <strong>Tips:</strong>
                        <ul class="small text-muted mt-2 mb-0">
                            <li>Press Ctrl+Enter to send message</li>
                            <li>Maximum message length: 2000 characters</li>
                            <li>Switch roles in Configuration page</li>
                        </ul>
                    </div>
                    <div class="d-grid">
                        <a href="{{ url_for('config_page') }}" class="btn btn-outline-primary">
                            <i class="fas fa-cog me-1"></i>
                            Configure Settings
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
// Load personalities data
const personalityData = {
    'warm_caring': '温柔助理型',
    'enthusiastic_explorer': '热情探索型', 
    'patient_mentor': '耐心导师型',
    'humorous_friend': '幽默伙伴型',
    'socratic_teacher': '苏格拉底式导师型'
};

<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatContainer = document.getElementById('chat-container');
    const messageInput = document.getElementById('message-input');
    const sendButton = document.getElementById('send-button');
    const chatForm = document.getElementById('chat-form');
    const typingIndicator = document.getElementById('typing-indicator');
    const clearChatBtn = document.getElementById('clear-chat');
    const charCount = document.getElementById('char-count');

    // Initialize
    let messageHistory = [];
    
    // Character counter
    messageInput.addEventListener('input', function() {
        charCount.textContent = this.value.length;
    });

    // Handle form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        sendMessage();
    });

    // Handle Ctrl+Enter
    messageInput.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

    // Clear chat
    clearChatBtn.addEventListener('click', function() {
        if (confirm('Are you sure you want to clear the chat history?')) {
            clearChat();
        }
    });

    function sendMessage() {
        const message = messageInput.value.trim();
        if (!message) return;

        // Disable input during processing
        setInputEnabled(false);
        
        // Add user message to chat
        addMessage('user', message);
        
        // Clear input
        messageInput.value = '';
        charCount.textContent = '0';
        
        // Show typing indicator
        showTyping(true);

        // Send to API (streaming)
        (async () => {
            let response;
            try {
                response = await fetch('/api/chat/stream', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'text/event-stream'
                    },
                    body: JSON.stringify({ message })
                });
                if (!response.ok || !response.body) {
                    throw new Error('Network response was not ok');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                const messageElement = addMessage('assistant', '');
                showTyping(true);

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop() || '';

                    for (const line of lines) {
                        if (!line.startsWith('data: ')) continue;
                        try {
                            const data = JSON.parse(line.slice(6));
                            if (data.error) {
                                throw new Error(data.error);
                            }
                            if (data.done) {
                                continue;
                            }
                            if (data.chunk) {
                                const contentDiv = messageElement.querySelector('.message-content');
                                contentDiv.textContent += data.chunk;
                                scrollToBottom();
                            }
                        } catch (err) {
                            console.error('Error parsing streaming data:', err);
                        }
                    }
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('assistant', 'Sorry, an error occurred: ' + (error.message || String(error)));
                showToast('Error sending message: ' + (error.message || String(error)), 'error');
            } finally {
                showTyping(false);
                setInputEnabled(true);
                messageInput.focus();
            }
        })();
    }

    function addMessage(role, content) {
        // Remove welcome message if it exists
        const welcomeMsg = chatContainer.querySelector('.text-center');
        if (welcomeMsg) {
            welcomeMsg.remove();
        }

        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${role}`;
        
        const headerDiv = document.createElement('div');
        headerDiv.className = 'message-header';
        headerDiv.innerHTML = role === 'user' ? 
            '<i class="fas fa-user me-1"></i>You' : 
            '<i class="fas fa-robot me-1"></i>{{ assistant_name }}';
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'message-content';
        contentDiv.textContent = content;
        
        messageDiv.appendChild(headerDiv);
        messageDiv.appendChild(contentDiv);
        
        chatContainer.appendChild(messageDiv);
        scrollToBottom();
        
        return messageDiv;
    }

    function showTyping(show) {
        typingIndicator.style.display = show ? 'block' : 'none';
        if (show) scrollToBottom();
    }

    function setInputEnabled(enabled) {
        messageInput.disabled = !enabled;
        sendButton.disabled = !enabled;
    }

    function scrollToBottom() {
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function clearChat() {
        fetch('/api/history', {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                chatContainer.innerHTML = `
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <p>Start a conversation with {{ assistant_name }}!</p>
                        <p class="small">Current role: {{ current_role }}</p>
                    </div>
                `;
                showToast('Chat history cleared successfully', 'success');
            } else {
                throw new Error(data.error || 'Failed to clear history');
            }
        })
        .catch(error => {
            console.error('Error clearing chat:', error);
            showToast('Error clearing chat: ' + error.message, 'error');
        });
    }

    // Focus on input
    messageInput.focus();
    
    // Load personalities for quick switch
    loadPersonalities();
});

// Load personalities for quick switch
function loadPersonalities() {
    Promise.all([
        fetch('/api/personalities').then(r => r.json()),
        fetch('/api/role-info').then(r => r.json())
    ])
    .then(([personalitiesData, roleInfo]) => {
        const selector = document.getElementById('chat-personality-selector');
        const applyBtn = document.getElementById('apply-personality-chat-btn');
        
        // Clear existing options except first one
        while (selector.children.length > 1) {
            selector.removeChild(selector.lastChild);
        }
        
        // Add personality options
        Object.entries(personalitiesData.personalities).forEach(([pid, pname]) => {
            const option = document.createElement('option');
            option.value = pid;
            option.textContent = pname;
            if (pid === roleInfo.current_personality_id) {
                option.selected = true;
            }
            selector.appendChild(option);
        });
        
        selector.addEventListener('change', function() {
            applyBtn.disabled = !this.value || this.value === roleInfo.current_personality_id;
        });
    })
    .catch(error => {
        console.error('Error loading personalities:', error);
        showToast('Failed to load personalities', 'error');
    });
}

// Quick apply personality in chat
function quickApplyPersonality() {
    const selector = document.getElementById('chat-personality-selector');
    const personalityId = selector.value;
    
    if (!personalityId) {
        showToast('Please select a personality', 'error');
        return;
    }
    
    const personalityName = selector.options[selector.selectedIndex].text;
    
    if (confirm(`Switch to ${personalityName} personality?\n\nThis will clear your conversation history.`)) {
        // Get current role info first
        fetch('/api/role-info')
        .then(r => r.json())
        .then(roleInfo => {
            // Determine the role name to use
            let roleName = 'default';
            if (roleInfo && roleInfo.current_role && roleInfo.current_role !== 'Custom voice assistant') {
                // Try to find the role name from available roles
                return fetch('/api/roles').then(r => r.json()).then(rolesData => {
                    const currentRole = rolesData.roles.find(r => r.is_current);
                    if (currentRole) {
                        roleName = currentRole.name;
                    }
                    return roleName;
                });
            }
            return roleName;
        })
        .then(roleName => {
            return fetch('/api/custom-pairing', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    role: roleName,
                    personality_id: personalityId
                })
            });
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(data.message, 'success');
                // Clear chat display
                clearChatDisplay();
                // Update apply button state
                document.getElementById('apply-personality-chat-btn').disabled = true;
            } else {
                throw new Error(data.message || 'Failed to apply personality');
            }
        })
        .catch(error => {
            console.error('Error applying personality:', error);
            showToast('Error applying personality: ' + error.message, 'error');
        });
    }
}

// Clear chat display without API call
function clearChatDisplay() {
    const chatContainer = document.getElementById('chat-container');
    chatContainer.innerHTML = `
        <div class="text-center text-muted py-5">
            <i class="fas fa-robot fa-3x mb-3"></i>
            <p>Start a conversation with {{ assistant_name }}!</p>
            <p class="small">Current role: {{ current_role }}</p>
        </div>
    `;
}
</script>
{% endblock %}